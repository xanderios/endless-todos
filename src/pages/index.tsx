import Head from "next/head";
import React, { useEffect, useState } from "react";
import { twMerge } from "tailwind-merge";

import { TodoItem } from "~/components/TodoItem";
import { useTodos } from "~/contexts/TodosContext";

export default function Home() {
  const { todos, addTodo } = useTodos();
  const [newTodoText, setNewTodoText] = useState("");

  const todosWithoutParent = Array.from(todos).filter(
    ([, todo]) => !todo.parentId && todo
  );

  useEffect(() => {
    document.body.className = "bg-charcoal-700";
  });

  const handleAddTodo = () => {
    if (newTodoText.trim() !== "") {
      addTodo(null, newTodoText);
      setNewTodoText("");
    }
  };

  const handleKeypress = (e: React.KeyboardEvent<HTMLInputElement>) => {
    if (e.key === "Enter") {
      handleAddTodo();
    }
  };

  return (
    <>
      <Head>
        <title>Endless Todos</title>
        <meta name="description" content="Generated by create-t3-app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <div className="flex min-h-screen flex-col text-white">
        <div className="bg-charcoal-800 p-5 text-center">
          <h1 className="text-2xl font-bold tracking-wide">Endless Todos</h1>
        </div>
        <main className="mx-auto w-full max-w-md justify-center pt-32">
          {todosWithoutParent.length >= 1 &&
            todosWithoutParent.map(([id, todo]) => (
              <TodoItem key={id} todo={todo} />
            ))}

          <input
            type="text"
            placeholder="Add todo item"
            value={newTodoText}
            onBlur={handleAddTodo}
            onChange={(e) => setNewTodoText(e.target.value)}
            onKeyDown={handleKeypress}
            className={twMerge(
              "w-full rounded bg-charcoal-800 px-2 py-1 focus:outline-none"
            )}
          />
        </main>
      </div>
    </>
  );
}
